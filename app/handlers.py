import asyncio
from aiogram import Router
from aiogram.filters import Command, StateFilter
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

import app.keyboards as kb
from .ai import get_completion


class Ai(StatesGroup):
    response = State()


class Post(StatesGroup):
    confirm = State()
    create = State()


router = Router()


@router.message(Command("start"))
async def start_handler(message: Message):
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç! üòä‚ú®\n\n–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É –æ–Ω–ª–∞–π–Ω-—à–∫–æ–ª—É –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏–≥—Ä –Ω–∞ Unreal Engine 5, –≥–¥–µ –º–µ—á—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é! üéÆüíª\n\n"
        "–ó–¥–µ—Å—å —Ç—ã –Ω–∞—É—á–∏—à—å—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–µ –º–∏—Ä—ã, –æ–∂–∏–≤–ª—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –≤–æ–ø–ª–æ—â–∞—Ç—å —Å–≤–æ–∏ –∏–¥–µ–∏ –≤ –∂–∏–∑–Ω—å. üí°üåç\n\n"
        "–ú—ã –ø–æ–º–æ–∂–µ–º —Ç–µ–±–µ —Å—Ç–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–º –º–∞—Å—Ç–µ—Ä–æ–º –≥–µ–π–º–¥–µ–≤–∞ –∏ –æ—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä–∏ –≤ –∏–Ω–¥—É—Å—Ç—Ä–∏—é –∏–≥—Ä. üöÄüìö\n\n"
        "–î–∞–≤–∞–π —Å–æ–∑–¥–∞–≤–∞—Ç—å –±—É–¥—É—â–µ–µ –∏–≥—Ä –≤–º–µ—Å—Ç–µ! #UnrealEngine5 #–ì–µ–π–º–¥–µ–≤",
        reply_markup=kb.main_keyboard
    )


@router.message(Command("help"))
async def help_commands(message: Message):
    await message.answer("""üìå –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥:
üîπ /start ‚Äì –ù–∞—á–∞—Ç—å
–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –í—ã —É–∑–Ω–∞–µ—Ç–µ, —á–µ–º –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –±–æ—Ç, –∏ –ø–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É –º–µ–Ω—é.

üîπ /help ‚Äì –ü–æ–º–æ—â—å
–ü–æ–∑–≤–æ–ª—è–µ—Ç —É–∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –±–æ—Ç–µ. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥ —Å –∏—Ö –æ–ø–∏—Å–∞–Ω–∏–µ–º.

üîπ /ai ‚Äì AI-–ø–æ–º–æ—â–Ω–∏–∫
–ó–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–º–æ—â–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç:
‚Äî –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ Unreal Engine 5
‚Äî –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –∏–≥—Ä
‚Äî –ü–æ–º–æ–≥–∞—Ç—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
‚Äî –û–±—ä—è—Å–Ω—è—Ç—å –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –≥–µ–π–º–¥–µ–≤–∞

üîπ /post ‚Äì –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç
–ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞. –ë–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –≤–∞–º –Ω–∞–ø–∏—Å–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç, –∞ –∑–∞—Ç–µ–º –≤—ã —Å–º–æ–∂–µ—Ç–µ –ª–∏–±–æ —É—Ç–≤–µ—Ä–¥–∏—Ç—å –µ–≥–æ, –ª–∏–±–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å.

üí° –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ! –í–Ω–∏–∑—É —Å–ª–µ–≤–∞ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ "–ú–µ–Ω—é", –≥–¥–µ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω—É—é –∫–æ–º–∞–Ω–¥—É. üöÄ""")


@router.message(Command("ai"))
async def ai_start(message: Message, state: FSMContext):
    await message.answer(
        "–ü—Ä–∏–≤–µ—Ç, –≤–æ—Ç —á—Ç–æ —è –º–æ–≥—É:\n\n- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ Unreal Engine 5\n- –ü–æ–º–æ–≥–∞—Ç—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏\n"
        "- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n- –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –≥–µ–π–º–¥–µ–≤—É"
    )
    await state.set_state(Ai.response)


@router.message(StateFilter(Ai.response))
async def ai_response(message: Message, state: FSMContext):
    loading_message = await message.answer('–î—É–º–∞—é...')
    await asyncio.sleep(1)
    await waiting(loading_message)
    response = await get_completion(message.text)
    await message.answer(response)
    await state.clear()


async def waiting(message: Message):
    loading_list = ['–î—É–º–∞—é.', '–î—É–º–∞—é..', '–î—É–º–∞—é...']
    for phrase in loading_list:
        await message.edit_text(text=phrase)
        await asyncio.sleep(1)